---
title: "part2.Rmd"
output: pdf_document
---
```{r}
library(rBLAST)
library(Biostrings)
library(seqinr)
source('mutblast_functions.R')
```

Download the whole E.coli set. 
```{r}
download.file("ftp://ftp.ensemblgenomes.org/pub/bacteria/release-42/fasta/bacteria_0_collection/escherichia_coli_str_k_12_substr_mg1655/cds/Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa.gz", "Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa.gz")

# uncompress the file
R.utils::gunzip("Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa.gz", overwrite=TRUE)

```

Used makeblastdb and blast function from rBLAST library to make database. And then we got the number of sequences is 4,140 sequences
```{r}
makeblastdb("Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa", dbtype="nucl", "-parse_seqids")

db <- blast(db='Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa')
db
```


Download sample.fa from GitHub. Use BioString to read sequence after that we use width function to get length of squence. To calcutate GC proportion we use GC function from seqinr library. We got length of sequence is 273 and GC proportion is 0.4908425

```{r}
download.file("https://raw.githubusercontent.com/markziemann/SLE712_files/master/bioinfo_asst3_part2_files/sample.fa", destfile ="sample.fa")
all_sequences <- Biostrings:::readBStringSet('sample.fa') # read all sequences
seq <- all_sequences[13] # get my sequence
length_seq <- width(seq)
cat('Length of sequence: ', length_seq, '\n')
seq_char <- seqinr::s2c(toString(seq)) # convert BStringSet to vector of single characters
gc_proportion <- seqinr::GC(seq_char) # calculate GC proportion
cat('GC Proportion: ', gc_proportion)
```
#### Question 3
We used provided myblastn_tab function to  `create database` and `search` sequence in database. We only got two significants matching.

```{r}
pred <- myblastn_tab(toString(seq), 'Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa')
head(pred, 3)
```




```{r}
seq_char <- seqinr::s2c(toString(seq)) # Create vector of single character from BioString
mut_seq <- mutator(seq_char, 15) # try to create a mutation sequence from originial sequence, in this case we tried to make 100 mutate positions

compare <- seq_char == mut_seq # try to compare original sequence and mutate sequence
mutate <- which(compare == FALSE) # mutate positions
num_mutate <- length(mutate) # number of mutate positions
num_mutate
```

```{r}
lst_mut_num <- seq(1, length(seq_char))

matching <- function(nmut) {
  db_path <- 'Escherichia_coli_str_k_12_substr_mg1655.ASM584v2.cds.all.fa'
  mut_seq_char <- mutator(seq_char, nmut)
  mut_seq <- seqinr::c2s(mut_seq_char)
  match_table <- (myblastn_tab(mut_seq, db_path))
  num_match <- dim(match_table)[1]
  if (is.null(num_match)) {
    return(0)
  }else{
    return(num_match)
  }
}

result <- unlist(lapply(lst_mut_num, matching))

is_match <- result > 0

lst_propotion <- rep(0, length(result))

interval <- 10
n_interval <- as.integer(length(result) / interval)
for (i in 1:n_interval) {
  first <- (i-1)*interval + 1
  if (i==n_interval) {
    last <- length(result)
  } else {
    last <- i*interval
  }
  print(first)
  print(last)
  print("==================")
  sum <- sum(is_match[first:last])
  lst_propotion[first:last] <- sum / interval
  
}


#plot(lst_mut_num, lst_propotion, type='l')

```


